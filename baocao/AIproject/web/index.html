<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot N6 - Hybrid AI</title>
    <style>
        /* CSS cho giao di·ªán Full Screen, phong c√°ch ChatGPT */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: #f0f4f9; /* N·ªÅn nh·∫π nh√†ng */
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: stretch;
            overflow: hidden;
        }
        .chat-container {
            width: 100%;
            max-width: 100%;
            height: 100%;
            background: white;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
.chat-header {
    background: #f7f7f8;
    color: #202123;
    padding: 18px 25px;
    position: relative;
    display: flex;
    /* D√πng space-between ƒë·ªÉ ƒë·∫©y hai b√™n ra xa nhau */
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ececf1;
}
.header-left {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 0 0 auto;
}
.chat-header h1 {
    font-size: 20px;
    margin: 0;
    font-weight: 600;
    color: #202123;
}
.header-robot-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.header-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    margin-left: 30px;
    margin-right: 30px;
    flex: 1;
}
.user-info {
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #6c757d;
    font-weight: 500;
}
.user-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #a8d5e2;
    color: #202123;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    border: 1px solid #90c2cf;
}

.header-actions {
    display: flex;
    gap: 12px;
    flex: 0 0 auto;
}
.header-btn {
    padding: 8px 12px;
    background: #e0e0e0;
    color: #202123;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
}
.header-btn:hover {
    background: #d4d4d4; /* N·ªÅn t·ªëi h∆°n khi hover */
}
/* Icon cho n√∫t */
.header-btn svg {
    width: 16px;
    height: 16px;
}

        /* MESSAGE AREA */
        .chat-messages {
            flex: 1;
            padding: 20px 0; /* Padding tr√™n d∆∞·ªõi, padding tr√°i ph·∫£i s·∫Ω do message t·ª± cƒÉn gi·ªØa */
            overflow-y: auto;
            background: #ffffff;
            scroll-behavior: smooth;
        }
        .message {
            margin-bottom: 18px;
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease;
            max-width: 900px; /* GI·ªöI H·∫†N WIDTH C·ª¶A TIN NH·∫ÆN */
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px; /* Th√™m padding ngang ƒë·ªÉ n·ªôi dung kh√¥ng ch·∫°m m√©p */
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .message.user {
            justify-content: flex-end;
        }
        .message-content {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 8px;
            word-wrap: break-word;
            line-height: 1.5;
            position: relative;
            font-size: 15px;
        }
        .message.user .message-content {
            background: #a8d5e2;
            color: #202123;
            border-bottom-right-radius: 4px;
        }
        .message.bot .message-content {
            background: #f0f0f0;
            color: #202123;
            border-bottom-left-radius: 4px;
            box-shadow: none;
            display: flex; /* D√ôNG FLEX ƒê·ªÇ CANH CH·ªàNH N·ªòI DUNG V√Ä BADGE */
            flex-direction: column;
            align-items: flex-start;
        }
        .bot-text {
            margin-bottom: 6px; /* Kho·∫£ng c√°ch gi·ªØa text v√† badge */
        }

        /* BADGE (Ngu·ªìn) */
        .source-badge {
            display: inline-flex; /* D√πng inline-flex ƒë·ªÉ cƒÉn ch·ªânh badge v√† confidence */
            align-items: center;
            font-size: 9px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 500;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-top: -3px; /* ƒê·∫©y badge l√™n s√°t h∆°n v·ªõi text */
        }
        .source-custom {
            background: #e6ffed;
            color: #0f5132;
        }
        .source-gemini {
            background: #e0f2fe;
            color: #084298;
        }
        .source-math {
            background: #fffbe6;
            color: #664d03;
        }
        .source-exact {
            background: #e6f7ff;
            color: #0c5460;
        }
        .confidence {
            font-size: 9px;
            color: #495057; /* M√†u t·ªëi h∆°n cho ƒë·ªô t∆∞∆°ng ph·∫£n */
            margin-left: 4px;
        }

        /* INPUT AREA */
        .chat-input-area {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #ececf1;
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .chat-input-content {
            display: flex;
            width: 100%;
            max-width: 900px;
            gap: 10px;
        }
        #userInput {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 15px;
            outline: none;
            transition: all 0.2s ease;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 150px;
            overflow-y: auto;
        }
        #userInput:focus {
            border-color: #a8d5e2;
            box-shadow: 0 0 0 2px rgba(168, 213, 226, 0.2);
        }
        #sendBtn {
            padding: 12px 25px;
            background: #a8d5e2;
            color: #202123;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s ease;
            box-shadow: none;
        }
        #sendBtn:hover {
            background: #90c2cf;
        }
        #sendBtn:active {
            background: #80b0bd;
        }
        #sendBtn:disabled {
            background: #e0e0e0;
            color: #a0a0a0;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* TYPING INDICATOR & WELCOME */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #a8d5e2;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            max-width: 900px;
            margin: 0 auto;
        }
        .welcome-message h2 {
            color: #a8d5e2;
            margin-bottom: 10px;
        }
        .loading-history {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-left">
                <div class="header-robot-icon">ü§ñ</div>
                <h1>Chatbot N6</h1>
            </div>

            <div class="header-center">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">ƒêang t·∫£i...</span>
                </div>
            </div>

            <div class="header-actions">
                <button class="header-btn" onclick="clearHistory()">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
                <button class="header-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="loading-history">
                <p>‚è≥ ƒêang t·∫£i l·ªãch s·ª≠ chat...</p>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="chat-input-content">
                <input
                    type="text"
                    id="userInput"
                    placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..."
                    autocomplete="off"
                >
                <button id="sendBtn" onclick="sendMessage()">G·ª≠i</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

        // C·∫•u h√¨nh Firebase (Thay b·∫±ng config c·ªßa b·∫°n)
       const firebaseConfig = {
            apiKey: "AIzaSyCdL3GxcWzyLbbMlEP4ToVPe0dSPR5ViyE",
            authDomain: "chatbotn6-de9f1.firebaseapp.com",
            projectId: "chatbotn6-de9f1",
            storageBucket: "chatbotn6-de9f1.firebasestorage.app",
            messagingSenderId: "15539268426",
            appId: "1:15539268426:web:cbeb707dfd5d4354f5efb3",
            measurementId: "G-0PGB5CKS5Z"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let currentUserId = null;
        let currentUserName = null;
        let chatHistory = [];
        const chatMessages = document.getElementById('chatMessages');

        // H√†m cu·ªôn xu·ªëng cu·ªëi tin nh·∫Øn v·ªõi ƒë·ªô tr·ªÖ
        function scrollToBottom(delay = 100) {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, delay);
        }


        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                // L·∫•y DisplayName ho·∫∑c email ph·∫ßn tr∆∞·ªõc @ l√†m t√™n
                currentUserName = user.displayName || user.email.split('@')[0];

                // Hi·ªÉn th·ªã th√¥ng tin user
                document.getElementById('userName').textContent = currentUserName;
                document.getElementById('userAvatar').textContent = currentUserName.charAt(0).toUpperCase();

                // T·∫£i l·ªãch s·ª≠ chat
                await loadChatHistory();
            } else {
                // Ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn v·ªÅ trang login
                window.location.href = '/login.html';
            }
        });

        // T·∫£i l·ªãch s·ª≠ chat v√† cu·ªôn xu·ªëng cu·ªëi
        async function loadChatHistory() {
            chatMessages.innerHTML = '<div class="loading-history"><p>‚è≥ ƒêang t·∫£i l·ªãch s·ª≠ chat...</p></div>';

            try {
                const response = await fetch('/get_history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUserId
                    })
                });

                const data = await response.json();
                chatHistory = data.history || [];

                // X√≥a loading
                chatMessages.innerHTML = '';

                if (chatHistory.length === 0) {
                    // Hi·ªÉn th·ªã welcome message
                    showWelcomeMessage();
                } else {
                    // Hi·ªÉn th·ªã l·ªãch s·ª≠
                    chatHistory.forEach(msg => {
                        // T·∫ÆT cu·ªôn t·ª± ƒë·ªông khi th√™m t·ª´ng tin nh·∫Øn
                        addMessage(msg.user, 'user', null, null, false);
                        addMessage(msg.bot, 'bot', msg.source, msg.confidence, false);
                    });

                    // CH·ªà cu·ªôn m·ªôt l·∫ßn duy nh·∫•t sau khi t·∫£i xong to√†n b·ªô l·ªãch s·ª≠
                    scrollToBottom(100);
                }

            } catch (error) {
                console.error('Error loading history:', error);
                chatMessages.innerHTML = '';
                showWelcomeMessage();
                // Hi·ªÉn th·ªã th√™m th√¥ng b√°o l·ªói n·∫øu c·∫ßn
                addMessage('‚ö†Ô∏è L·ªói k·∫øt n·ªëi API: Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ chat', 'bot', 'system_error', null, true);
            }
        }

        function showWelcomeMessage() {
            const welcome = document.createElement('div');
            welcome.className = 'welcome-message';
            welcome.innerHTML = `
                <h2>Xin ch√†o, ${currentUserName}! üëã</h2>
                <p>T√¥i l√† chatbot th√¥ng minh k·∫øt h·ª£p gi·ªØa:</p>
                <p>üéØ <strong>Custom Model</strong> - C√¢u h·ªèi v·ªÅ d·ªØ li·ªáu ƒë√£ h·ªçc</p>
                <p>üß† <strong>Gemini AI</strong> - C√¢u h·ªèi ph·ª©c t·∫°p, suy lu·∫≠n</p>
                <p style="margin-top: 15px; font-size: 13px;">H√£y th·ª≠ h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨!</p>
            `;
            chatMessages.appendChild(welcome);
        }

        // G·ª≠i tin nh·∫Øn
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                window.sendMessage();
            }
        });

        window.sendMessage = async function() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();

            if (!message) return;

            addMessage(message, 'user');
            userInput.value = '';

            const typingDiv = showTyping();

            try {
                // Chu·∫©n b·ªã l·ªãch s·ª≠ g·∫ßn nh·∫•t (10 tin cu·ªëi)
                const recentHistory = chatHistory.slice(-10);

                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        user_id: currentUserId,
                        history: recentHistory
                    })
                });

                const data = await response.json();
                typingDiv.remove();

                // Th√™m v√†o l·ªãch s·ª≠ local
                chatHistory.push({
                    user: message,
                    bot: data.response,
                    source: data.source,
                    confidence: data.confidence
                });

                addMessage(data.response, 'bot', data.source, data.confidence);

            } catch (error) {
                typingDiv.remove();
                addMessage('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'bot', 'error');
            }
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typing-indicator';

            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';

            typingDiv.appendChild(content);
            chatMessages.appendChild(typingDiv);

            // Cu·ªôn nhanh ƒë·ªÉ hi·ªÉn th·ªã typing indicator
            scrollToBottom(50);

            return typingDiv;
        }

        // Th√™m tin nh·∫Øn v√† g·ªçi cu·ªôn ·ªïn ƒë·ªãnh
        function addMessage(text, sender, source = null, confidence = null, scroll = true) {

            const welcome = chatMessages.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            // X·ª≠ l√Ω tin nh·∫Øn l·ªói h·ªá th·ªëng
            if (source === 'system_error' || source === 'error') {
                const sysDiv = document.createElement('div');
                sysDiv.className = 'message bot';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.style.backgroundColor = '#f8d7da';
                contentDiv.style.color = '#721c24';
                contentDiv.style.border = '1px solid #f5c6cb';
                contentDiv.textContent = text;

                sysDiv.appendChild(contentDiv);
                chatMessages.appendChild(sysDiv);

                if (scroll) scrollToBottom(100);
                return;
            }


            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // PH·∫¶N TEXT C·ª¶A BOT
            const botText = document.createElement('div');
            botText.className = 'bot-text';
            // S·ª≠ d·ª•ng innerHTML ƒë·ªÉ hi·ªÉn th·ªã ng·∫Øt d√≤ng
            botText.innerHTML = text.replace(/\n/g, '<br>');
            contentDiv.appendChild(botText);

            if (sender === 'bot' && source) {
                const badge = document.createElement('div');
                let badgeText = '';
                let badgeClass = 'source-badge ';

                switch(source) {
                    case 'exact_match':
                    case 'fuzzy_match':
                        badgeText = 'üéØ Custom Model';
                        badgeClass += 'source-exact';
                        break;
                    case 'custom_model':
                    case 'custom_model_fallback':
                        badgeText = 'ü§ñ Custom Model';
                        badgeClass += 'source-custom';
                        break;
                    case 'gemini':
                        badgeText = 'üß† Gemini AI';
                        badgeClass += 'source-gemini';
                        break;
                    case 'math':
                        badgeText = 'üî¢ Math Logic';
                        badgeClass += 'source-math';
                        break;
                    default:
                        badgeText = '‚ùì Unknown';
                        badgeClass += 'source-custom';
                }

                badge.className = badgeClass;
                badge.textContent = badgeText; // ƒê·∫∑t text c∆° b·∫£n

                if (confidence) {
                    const confSpan = document.createElement('span');
                    confSpan.className = 'confidence';
                    confSpan.textContent = ` (${(confidence * 100).toFixed(0)}%)`;
                    badge.appendChild(confSpan);
                }

                contentDiv.appendChild(badge); // TH√äM BADGE V√ÄO MESSAGE CONTENT
            }

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);

            if (scroll) {
                // S·ª≠ d·ª•ng h√†m cu·ªôn ·ªïn ƒë·ªãnh
                scrollToBottom(100);
            }
        }

        // H√ÄM ƒê√É S·ª¨A: CH·ªà X√ìA L·ªäCH S·ª¨ T·∫†I CLIENT, KH√îNG X√ìA TR√äN FIREBASE
        window.clearHistory = async function() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ h·ªôi tho·∫°i tr√™n giao di·ªán n√†y? (L·ªãch s·ª≠ g·ªëc v·∫´n ƒë∆∞·ª£c l∆∞u tr√™n server)')) {
                return;
            }

            try {
                // X√≥a l·ªãch s·ª≠ trong b·ªô nh·ªõ tr√¨nh duy·ªát (client-side state)
                chatHistory = [];

                // X√≥a giao di·ªán hi·ªÉn th·ªã
                chatMessages.innerHTML = '';

                // Hi·ªÉn th·ªã l·∫°i l·ªùi ch√†o m·ª´ng
                showWelcomeMessage();

            } catch (error) {
                console.error('L·ªói khi x√≥a l·ªãch s·ª≠ giao di·ªán:', error);
            }
        }

        window.logout = async function() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                return;
            }

            try {
                await signOut(auth);
                localStorage.clear();
                window.location.href = '/login.html';
            } catch (error) {
                // Thay v√¨ alert(), s·ª≠ d·ª•ng giao di·ªán modal/message box
                const errorMessage = document.createElement('div');
                errorMessage.textContent = 'L·ªói khi ƒëƒÉng xu·∫•t: ' + error.message;
                errorMessage.style.cssText = "position:fixed; top:20px; right:20px; background:red; color:white; padding:10px; border-radius:5px; z-index:1000;";
                document.body.appendChild(errorMessage);
                setTimeout(() => errorMessage.remove(), 3000);
            }
        }

        window.onload = function() {
            document.getElementById('userInput').focus();
        };
    </script>
</body>
</html>